<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Analytics Hub</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Chart.js fallback -->
    <script>
        // Fallback for Chart.js if CDN fails
        if (typeof Chart === 'undefined') {
            console.warn('Primary Chart.js CDN failed, loading fallback...');
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"><\/script>');
        }
    </script>
    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --card-shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            margin-bottom: 3rem;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            z-index: 1;
        }

        .dashboard-header .content {
            position: relative;
            z-index: 2;
        }

        .dashboard-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dashboard-subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stats-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: none;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .stats-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--card-shadow-hover);
        }

        .stats-card.primary::before { background: var(--primary-gradient); }
        .stats-card.success::before { background: var(--success-gradient); }
        .stats-card.warning::before { background: var(--warning-gradient); }
        .stats-card.danger::before { background: var(--danger-gradient); }
        .stats-card.info::before { background: var(--info-gradient); }

        .stats-icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            background: var(--primary-gradient);
            color: white;
            font-size: 2rem;
        }

        .stats-card.success .stats-icon { background: var(--success-gradient); }
        .stats-card.warning .stats-icon { background: var(--warning-gradient); }
        .stats-card.danger .stats-icon { background: var(--danger-gradient); }
        .stats-card.info .stats-icon { background: var(--info-gradient); }

        .stats-number {
            font-size: 3rem;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-label {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            height: 400px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .control-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .btn-modern {
            border-radius: 50px;
            padding: 0.8rem 2rem;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            margin: 0.5rem;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .btn-primary-modern {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-warning-modern {
            background: var(--warning-gradient);
            color: white;
        }

        .btn-danger-modern {
            background: var(--danger-gradient);
            color: white;
        }

        .table-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .table-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-weight: 600;
            padding: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #e9ecef;
        }

        .badge-modern {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-os {
            background: var(--primary-gradient);
            color: white;
        }

        .badge-browser {
            background: var(--success-gradient);
            color: white;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .status-online {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .status-offline {
            background: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            z-index: 1000;
        }

        .refresh-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: var(--card-shadow-hover);
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .dashboard-title {
                font-size: 2.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .chart-container {
                height: 300px;
                padding: 1rem;
            }
            
            .chart-wrapper {
                height: 200px;
            }
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--card-shadow);
            z-index: 1001;
            transform: translateX(400px);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #28a745;
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        .avatar-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        /* Authentication Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .auth-modal-content {
            background: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        
        .auth-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .auth-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        .auth-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .auth-close:hover {
            background: #f8f9fa;
            color: #dc3545;
        }
        
        .auth-form-group {
            margin-bottom: 1.5rem;
        }
        
        .auth-form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .auth-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .auth-form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .auth-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .auth-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .auth-btn-primary {
            background: var(--primary-gradient);
            color: white;
        }
        
        .auth-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .auth-btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }
        
        .auth-btn-secondary:hover {
            background: #e9ecef;
        }
        
        /* Improved timestamp styling */
        .timestamp-cell {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
            background-color: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle me-2" id="notificationIcon"></i>
            <span id="notificationText">Action completed successfully</span>
            <button type="button" class="btn-close ms-auto" data-action="hide-notification"></button>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-btn" data-action="refresh-data" title="Refresh Data">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h3 class="auth-modal-title">
                    <i class="fas fa-shield-alt me-2"></i>
                    Authentication Required
                </h3>
                <button class="auth-close" data-action="close-auth-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="authForm">
                <div class="auth-form-group">
                    <label class="auth-form-label" for="authUsername">
                        <i class="fas fa-user me-1"></i>
                        Username
                    </label>
                    <input type="text" id="authUsername" class="auth-form-input" placeholder="Enter username" required>
                </div>
                <div class="auth-form-group">
                    <label class="auth-form-label" for="authPassword">
                        <i class="fas fa-lock me-1"></i>
                        Password
                    </label>
                    <input type="password" id="authPassword" class="auth-form-input" placeholder="Enter password" required>
                </div>
                <div class="auth-buttons">
                    <button type="button" class="auth-btn auth-btn-secondary" data-action="close-auth-modal">
                        Cancel
                    </button>
                    <button type="submit" class="auth-btn auth-btn-primary">
                        <i class="fas fa-check me-1"></i>
                        Authenticate
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Header Section -->
        <div class="dashboard-header fade-in">
            <div class="content text-center">
                <h1 class="dashboard-title">
                    <i class="fas fa-rocket me-3"></i>Nova Analytics Hub
                </h1>
                <p class="dashboard-subtitle">Advanced automation analytics and real-time insights</p>
                <div class="mt-3">
                    <span class="status-indicator status-online"></span>
                    <small>System Online • Last updated: <span id="lastUpdated">Just now</span></small>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid fade-in">
            <div class="stats-card primary">
                <div class="stats-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-number" id="totalUsers">{{ data|length }}</div>
                <div class="stats-label">Active Users</div>
                <small class="text-muted">Total registered users</small>
            </div>

            <div class="stats-card success">
                <div class="stats-icon">
                    <i class="fas fa-desktop"></i>
                </div>
                <div class="stats-number" id="uniqueOS">0</div>
                <div class="stats-label">Operating Systems</div>
                <small class="text-muted">Unique platforms detected</small>
            </div>

            <div class="stats-card warning">
                <div class="stats-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="stats-number" id="uniqueBrowsers">0</div>
                <div class="stats-label">Browsers</div>
                <small class="text-muted">Different browser types</small>
            </div>

            <div class="stats-card danger">
                <div class="stats-icon">
                    <i class="fas fa-mouse-pointer"></i>
                </div>
                <div class="stats-number" id="totalNovaClicks">0</div>
                <div class="stats-label">Nova Interactions</div>
                <small class="text-muted">Total automation clicks</small>
            </div>

            <div class="stats-card info">
                <div class="stats-icon">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="stats-number" id="mobileUsers">0</div>
                <div class="stats-label">Mobile Users</div>
                <small class="text-muted">Mobile device usage</small>
            </div>

            <div class="stats-card primary">
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-number" id="avgClicksPerUser">0</div>
                <div class="stats-label">Avg Clicks/User</div>
                <small class="text-muted">Average automation usage</small>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="chart-container fade-in">
                    <h4 class="table-title">
                        <i class="fas fa-desktop"></i>
                        Operating Systems Distribution
                    </h4>
                    <div class="chart-wrapper">
                        <canvas id="osChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="chart-container fade-in">
                    <h4 class="table-title">
                        <i class="fas fa-window-maximize"></i>
                        Browser Usage Analytics
                    </h4>
                    <div class="chart-wrapper">
                        <canvas id="browserChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Charts -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="chart-container fade-in">
                    <h4 class="table-title">
                        <i class="fas fa-chart-bar"></i>
                        Activity Timeline
                    </h4>
                    <div class="chart-wrapper">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="chart-container fade-in">
                    <h4 class="table-title">
                        <i class="fas fa-mobile-alt"></i>
                        Device Type Distribution
                    </h4>
                    <div class="chart-wrapper">
                        <canvas id="deviceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel fade-in">
            <h4 class="table-title">
                <i class="fas fa-cog"></i>
                System Controls
            </h4>
            <div class="d-flex justify-content-center flex-wrap">
                <button id="toggleAskButton" class="btn btn-modern btn-primary-modern">
                    <i class="fas fa-spinner loading-spinner me-2" style="display: none;"></i>
                    <span class="btn-text">Loading...</span>
                </button>
                <button id="clearDataButton" class="btn btn-modern btn-danger-modern">
                    <i class="fas fa-trash-alt me-2"></i>
                    Clear All Data
                </button>
                <button id="clearKeysButton" class="btn btn-modern btn-warning-modern">
                    <i class="fas fa-key me-2"></i>
                    Clear All Keys
                </button>
                <button id="exportDataButton" class="btn btn-modern btn-warning-modern">
                    <i class="fas fa-download me-2"></i>
                    Export Data
                </button>
                <button id="refreshDataButton" class="btn btn-modern btn-primary-modern">
                    <i class="fas fa-sync-alt me-2"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container fade-in">
            <h3 class="table-title">
                <i class="fas fa-database"></i>
                User Activity Records
                <small class="text-muted ms-auto">Real-time data updates</small>
            </h3>
            <div class="table-responsive">
                <table id="dataTable" class="table table-hover">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user me-2"></i>User</th>
                            <th><i class="fas fa-graduation-cap me-2"></i>Class</th>
                            <th><i class="fas fa-desktop me-2"></i>OS</th>
                            <th><i class="fas fa-globe me-2"></i>Browser</th>
                            <th><i class="fas fa-mobile-alt me-2"></i>Device</th>
                            <th><i class="fas fa-clock me-2"></i>Timestamp</th>
                            <th><i class="fas fa-mouse-pointer me-2"></i>Nova Clicks</th>
                            <th><i class="fas fa-cog me-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in data %}
                        <tr data-entry-id="{{ loop.index }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-2">
                                        {{ item.text.split('|')[0].split(':')[1].strip()[:1] if '|' in item.text and ':' in item.text.split('|')[0] else 'U' }}
                                    </div>
                                    <span class="fw-semibold">
                                        {{ item.text.split('|')[0].split(':')[1].strip() if '|' in item.text and ':' in item.text.split('|')[0] else 'Unknown User' }}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="badge badge-modern" style="background: var(--info-gradient); color: white;">
                                    {{ item.text.split('|')[1].split(':')[1].strip() if '|' in item.text and (item.text.split('|') | length) > 1 and ':' in item.text.split('|')[1] else 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-modern badge-os">
                                    <i class="fab fa-{{ 'windows' if 'Windows' in (item.os if item.os is defined else 'Unknown') else 'apple' if 'Mac' in (item.os if item.os is defined else 'Unknown') else 'linux' }} me-1"></i>
                                    {{ item.os if item.os is defined else 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-modern badge-browser">
                                    <i class="fab fa-{{ 'chrome' if 'Chrome' in (item.browser if item.browser is defined else 'Unknown') else 'firefox' if 'Firefox' in (item.browser if item.browser is defined else 'Unknown') else 'safari' if 'Safari' in (item.browser if item.browser is defined else 'Unknown') else 'edge' if 'Edge' in (item.browser if item.browser is defined else 'Unknown') else 'internet-explorer' }} me-1"></i>
                                    {{ item.browser if item.browser is defined else 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                {% if item.isMobile is defined and item.isMobile %}
                                    <span class="badge badge-modern" style="background: var(--warning-gradient); color: white;">
                                        <i class="fas fa-mobile-alt me-1"></i>
                                        {{ item.mobileType if item.mobileType is defined else 'Mobile' }}
                                    </span>
                                {% else %}
                                    <span class="badge badge-modern" style="background: var(--success-gradient); color: white;">
                                        <i class="fas fa-desktop me-1"></i>
                                        Desktop
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="timestamp-cell">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    {{ item.timestamp if item.timestamp is defined else 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-modern" style="background: var(--danger-gradient); color: white; font-size: 0.9rem;">
                                    {{ item.novaClicks if item.novaClicks is defined else 'N/A' }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm" data-action="view" data-entry-id="{{ loop.index }}" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" data-action="delete" data-entry-id="{{ loop.index }}" title="Delete Entry">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
        // Global variables
        let dashboardData = [];
        let charts = {};
        let dataTable;

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const text = document.getElementById('notificationText');
            
            notification.className = `notification ${type} show`;
            icon.className = type === 'success' ? 'fas fa-check-circle me-2' : 'fas fa-exclamation-circle me-2';
            text.textContent = message;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function animateNumber(element, targetValue, duration = 1000) {
            const startValue = parseInt(element.textContent) || 0;
            const increment = (targetValue - startValue) / (duration / 16);
            let currentValue = startValue;
            
            const timer = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= targetValue) || (increment < 0 && currentValue <= targetValue)) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = Math.round(currentValue);
            }, 16);
        }

        // Chart creation functions
        function createModernChart(canvasId, chartType, labels, data, title, colors) {
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded. Skipping chart creation for:', canvasId);
                showNotification('Chart library failed to load. Charts may not display.', 'error');
                return;
            }
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error('Canvas element not found:', canvasId);
                return;
            }
            
            const context = ctx.getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            const gradientColors = colors.map(color => {
                const gradient = context.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color + '80');
                gradient.addColorStop(1, color + '20');
                return gradient;
            });

            const config = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: chartType === 'line' ? gradientColors : colors,
                        borderColor: colors,
                        borderWidth: chartType === 'line' ? 3 : 0,
                        tension: 0.4,
                        fill: chartType === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 10,
                            displayColors: false
                        }
                    },
                    scales: chartType === 'line' ? {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    } : {},
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            };

            try {
                charts[canvasId] = new Chart(context, config);
            } catch (error) {
                console.error('Error creating chart:', canvasId, error);
                showNotification(`Failed to create ${title} chart`, 'error');
            }
        }

        // Data processing functions
        function processData(data) {
            // Calculate unique users by parsing user names from the text field
            const userNames = new Set();
            data.forEach(item => {
                if (item.text && item.text.includes('|') && item.text.includes(':')) {
                    // Extract user name from the text field (format: "User: Name | Class: ...")
                    const userPart = item.text.split('|')[0];
                    if (userPart.includes(':')) {
                        const userName = userPart.split(':')[1].trim();
                        if (userName) {
                            userNames.add(userName);
                        }
                    }
                }
            });
            const uniqueUsers = userNames.size;

            // Calculate unique OS
            const uniqueOS = new Set(data.map(item => item.os || 'Unknown')).size;

            // Calculate unique browsers
            const uniqueBrowsers = new Set(data.map(item => item.browser || 'Unknown')).size;

            // Calculate total Nova clicks
            const totalNovaClicks = data.reduce((sum, item) => sum + (item.novaClicks || 0), 0);

            // Calculate mobile users
            const mobileUsers = data.filter(item => item.isMobile).length;

            // Calculate average clicks per user
            const avgClicksPerUser = uniqueUsers > 0 ? (totalNovaClicks / uniqueUsers).toFixed(1) : 0;

            return {
                uniqueUsers,
                uniqueOS,
                uniqueBrowsers,
                totalNovaClicks,
                mobileUsers,
                avgClicksPerUser
            };
        }

        function updateStatistics(stats) {
            animateNumber(document.getElementById('totalUsers'), stats.uniqueUsers);
            animateNumber(document.getElementById('uniqueOS'), stats.uniqueOS);
            animateNumber(document.getElementById('uniqueBrowsers'), stats.uniqueBrowsers);
            animateNumber(document.getElementById('totalNovaClicks'), stats.totalNovaClicks);
            animateNumber(document.getElementById('mobileUsers'), stats.mobileUsers);
            document.getElementById('avgClicksPerUser').textContent = stats.avgClicksPerUser;
        }

        function createCharts(data) {
            // Check if Chart.js is available before creating charts
            if (typeof Chart === 'undefined') {
                console.error('Chart.js library is not loaded. Charts will not be displayed.');
                showNotification('Chart library not available. Please refresh the page.', 'error');
                return;
            }
            
            try {
                // OS Chart
                const osCounts = {};
                data.forEach(item => {
                    const os = item.os || 'Unknown';
                    osCounts[os] = (osCounts[os] || 0) + 1;
                });
                
                createModernChart(
                    'osChart', 
                    'doughnut',
                    Object.keys(osCounts),
                    Object.values(osCounts),
                    'Operating Systems',
                    ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe']
                );

                // Browser Chart
                const browserCounts = {};
                data.forEach(item => {
                    const browser = item.browser || 'Unknown';
                    browserCounts[browser] = (browserCounts[browser] || 0) + 1;
                });
                
                createModernChart(
                    'browserChart',
                    'doughnut',
                    Object.keys(browserCounts),
                    Object.values(browserCounts),
                    'Browsers',
                    ['#43e97b', '#38f9d7', '#fa709a', '#fee140', '#a8edea', '#fed6e3']
                );

                // Activity Timeline Chart
                const activityByHour = new Array(24).fill(0);
                data.forEach(item => {
                    if (item.timestamp) {
                        // Parse the formatted timestamp to extract hour
                        const timestampStr = item.timestamp;
                        // Extract time part (e.g., "02:30 PM EST")
                        const timeMatch = timestampStr.match(/(\d{1,2}:\d{2}\s*(?:AM|PM))/i);
                        if (timeMatch) {
                            const timeStr = timeMatch[1];
                            // Convert to 24-hour format to get hour
                            const date = new Date(`1970-01-01 ${timeStr}`);
                            const hour = date.getHours();
                            activityByHour[hour]++;
                        }
                    }
                });
                
                createModernChart(
                    'activityChart',
                    'line',
                    Array.from({length: 24}, (_, i) => {
                        // Format hours in 12-hour format
                        const hour = i % 12 || 12;
                        const ampm = i < 12 ? 'AM' : 'PM';
                        return `${hour} ${ampm}`;
                    }),
                    activityByHour,
                    'Activity by Hour',
                    ['#667eea']
                );

                // Device Type Chart
                const deviceCounts = {
                    'Desktop': data.filter(item => !item.isMobile).length,
                    'Mobile': data.filter(item => item.isMobile).length
                };
                
                createModernChart(
                    'deviceChart',
                    'bar',
                    Object.keys(deviceCounts),
                    Object.values(deviceCounts),
                    'Device Types',
                    ['#4facfe', '#00f2fe']
                );
            } catch (error) {
                console.error('Error creating charts:', error);
                showNotification('Failed to create analytics charts', 'error');
            }
        }

        // API functions
        async function fetchData() {
            // For initial load, extract data from the table
            return extractDataFromTable();
        }
        
        function extractDataFromTable() {
            const tableRows = document.querySelectorAll('#dataTable tbody tr');
            const data = [];
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    // Extract user name
                    const userCell = cells[0].querySelector('.fw-semibold');
                    const userName = userCell ? userCell.textContent.trim() : 'Unknown';
                    
                    // Extract class name
                    const classCell = cells[1].querySelector('.badge');
                    const className = classCell ? classCell.textContent.trim() : 'Unknown';
                    
                    // Extract OS
                    const osCell = cells[2].querySelector('.badge-os');
                    const os = osCell ? osCell.textContent.trim().replace(/^[\w-]+\s+/, '') : 'Unknown';
                    
                    // Extract browser
                    const browserCell = cells[3].querySelector('.badge-browser');
                    const browser = browserCell ? browserCell.textContent.trim().replace(/^[\w-]+\s+/, '') : 'Unknown';
                    
                    // Extract device type
                    const deviceCell = cells[4].querySelector('.badge');
                    const isMobile = deviceCell ? deviceCell.textContent.includes('Mobile') : false;
                    const mobileType = isMobile ? deviceCell.textContent.trim() : 'Desktop';
                    
                    // Extract timestamp
                    const timestampCell = cells[5].querySelector('.timestamp-cell');
                    const timestamp = timestampCell ? timestampCell.textContent.trim().replace(/^[\w-]+\s+/, '') : 'Unknown';
                    
                    // Extract nova clicks
                    const clicksCell = cells[6].querySelector('.badge');
                    const novaClicks = clicksCell ? parseInt(clicksCell.textContent.trim()) || 0 : 0;
                    
                    data.push({
                        text: `User: ${userName} | Class: ${className}`,
                        os: os,
                        browser: browser,
                        isMobile: isMobile,
                        mobileType: mobileType,
                        timestamp: timestamp,
                        novaClicks: novaClicks
                    });
                }
            });
            
            return data;
        }

        async function fetchAskStatus() {
            try {
                const response = await fetch('/ask-status');
                if (!response.ok) throw new Error('Failed to fetch status');
                return await response.json();
            } catch (error) {
                console.error('Error fetching ask status:', error);
                return { enabled: false };
            }
        }

        async function toggleAskStatus() {
            const button = document.getElementById('toggleAskButton');
            const spinner = button.querySelector('.loading-spinner');
            const text = button.querySelector('.btn-text');
            
            // Show loading state
            spinner.style.display = 'inline-block';
            text.textContent = 'Processing...';
            button.disabled = true;
            
            try {
                const currentStatus = await fetchAskStatus();
                const response = await fetch('/toggle-ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !currentStatus.enabled })
                });
                
                if (!response.ok) throw new Error('Failed to toggle status');
                
                const result = await response.json();
                updateAskButton(!currentStatus.enabled);
                showNotification(result.message, 'success');
            } catch (error) {
                console.error('Error toggling ask status:', error);
                showNotification('Failed to toggle status', 'error');
            } finally {
                spinner.style.display = 'none';
                button.disabled = false;
            }
        }

        function updateAskButton(enabled) {
            const button = document.getElementById('toggleAskButton');
            const text = button.querySelector('.btn-text');
            
            if (enabled) {
                text.textContent = 'Disable Ask';
                button.className = 'btn btn-modern btn-warning-modern';
            } else {
                text.textContent = 'Enable Ask';
                button.className = 'btn btn-modern btn-primary-modern';
            }
        }

        async function clearData() {
            if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                return;
            }
            
            // Show authentication modal
            showAuthModal();
        }
        
        function showAuthModal(action = 'clearData') {
            window.currentAuthAction = action;
            const modal = document.getElementById('authModal');
            const title = document.querySelector('.auth-modal-title');
            
            if (action === 'clearKeys') {
                title.innerHTML = '<i class="fas fa-key me-2"></i>Authenticate to Clear Keys';
            } else {
                title.innerHTML = '<i class="fas fa-shield-alt me-2"></i>Authentication Required';
            }
            
            modal.style.display = 'block';
            document.getElementById('authUsername').focus();
        }
        
        function closeAuthModal() {
            const modal = document.getElementById('authModal');
            modal.style.display = 'none';
            // Clear form
            document.getElementById('authForm').reset();
        }
        
        async function performClearData(username, password) {
            try {
                // Create credentials for Basic Auth
                const credentials = btoa(`${username}:${password}`);
                
                const response = await fetch('/clear-data', { 
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${credentials}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    showNotification('Authentication failed. Please check your credentials.', 'error');
                    return false;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                showNotification(result.message, 'success');
                closeAuthModal();
                setTimeout(() => location.reload(), 1500);
                return true;
            } catch (error) {
                console.error('Error clearing data:', error);
                if (error.message.includes('401')) {
                    showNotification('Authentication failed. Please check your credentials.', 'error');
                } else {
                    showNotification(`Failed to clear data: ${error.message}`, 'error');
                }
                return false;
            }
        }

        async function clearKeys() {
            if (!confirm('Are you sure you want to clear all API keys? This action cannot be undone and will invalidate all existing keys.')) {
                return;
            }
            
            try {
                // Show authentication modal for key clearing
                showAuthModal('clearKeys');
            } catch (error) {
                console.error('Error initiating key clear:', error);
                showNotification('Failed to initiate key clearing', 'error');
            }
        }
        
        async function performClearKeys(username, password) {
            try {
                // Create credentials for Basic Auth
                const credentials = btoa(`${username}:${password}`);
                
                const response = await fetch('/clear-keys', { 
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${credentials}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    showNotification('Authentication failed. Please check your credentials.', 'error');
                    return false;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                showNotification(result.message, 'success');
                closeAuthModal();
                return true;
            } catch (error) {
                console.error('Error clearing keys:', error);
                if (error.message.includes('401')) {
                    showNotification('Authentication required. Please provide valid credentials.', 'error');
                } else {
                    showNotification(`Failed to clear keys: ${error.message}`, 'error');
                }
                return false;
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(dashboardData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `nova-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully', 'success');
        }

        async function refreshData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.style.transform = 'scale(1.1) rotate(180deg)';
            
            showNotification('Refreshing data...', 'success');
            
            // Since /data returns HTML, we need to reload the page to get fresh data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Utility functions for table actions
        function viewDetails(entryId) {
            // Implementation for viewing entry details
            showNotification(`Viewing details for entry ${entryId}`, 'success');
        }

        function deleteEntry(entryId) {
            if (confirm(`Are you sure you want to delete entry ${entryId}?`)) {
                // Implementation for deleting specific entry
                showNotification(`Entry ${entryId} deleted successfully`, 'success');
            }
        }

        // Event delegation for table action buttons and general UI actions
        function setupEventHandlers() {
            document.addEventListener('click', function(e) {
                const button = e.target.closest('[data-action]');
                if (!button) return;
                
                const action = button.getAttribute('data-action');
                const entryId = button.getAttribute('data-entry-id');
                
                switch(action) {
                    case 'view':
                        viewDetails(entryId);
                        break;
                    case 'delete':
                        deleteEntry(entryId);
                        break;
                    case 'hide-notification':
                        hideNotification();
                        break;
                    case 'refresh-data':
                        refreshData();
                        break;
                    case 'close-auth-modal':
                        closeAuthModal();
                        break;
                }
            });
        }

        // Initialize dashboard
        $(document).ready(async function() {
            try {
                // Setup event handlers
                setupEventHandlers();
                
                // Setup authentication modal event handlers
                document.getElementById('authForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const username = document.getElementById('authUsername').value;
                    const password = document.getElementById('authPassword').value;
                    
                    if (!username || !password) {
                        showNotification('Please enter both username and password', 'error');
                        return;
                    }
                    
                    // Check what action we're performing
                    if (window.currentAuthAction === 'clearKeys') {
                        await performClearKeys(username, password);
                    } else {
                        await performClearData(username, password);
                    }
                });

                // Close modal when clicking outside
                document.getElementById('authModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeAuthModal();
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && document.getElementById('authModal').style.display === 'block') {
                        closeAuthModal();
                    }
                });
                
                // Initialize DataTable
                dataTable = $('#dataTable').DataTable({
                    order: [[5, 'desc']],
                    pageLength: 25,
                    responsive: true,
                    language: {
                        search: 'Search records:',
                        lengthMenu: 'Show _MENU_ entries per page',
                        info: 'Showing _START_ to _END_ of _TOTAL_ entries',
                        paginate: {
                            previous: 'Previous',
                            next: 'Next'
                        }
                    }
                });

                // Fetch and process data
                dashboardData = await fetchData();
                const stats = processData(dashboardData);
                updateStatistics(stats);
                
                // Create charts with error handling
                createCharts(dashboardData);

                // Update ask button status
                try {
                    const askStatus = await fetchAskStatus();
                    updateAskButton(askStatus.enabled);
                } catch (error) {
                    console.error('Failed to fetch ask status:', error);
                    showNotification('Failed to load system status', 'error');
                }
                
                updateLastUpdated();

                // Event listeners for control buttons
                document.getElementById('toggleAskButton').addEventListener('click', toggleAskStatus);
                document.getElementById('clearDataButton').addEventListener('click', clearData);
                document.getElementById('clearKeysButton').addEventListener('click', clearKeys);
                document.getElementById('exportDataButton').addEventListener('click', exportData);
                document.getElementById('refreshDataButton').addEventListener('click', refreshData);
                
                // Auto-refresh every 5 minutes (since it reloads the page)
                setInterval(async () => {
                    showNotification('Auto-refreshing data...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }, 300000); // 5 minutes
                
                // Welcome message
                setTimeout(() => {
                    showNotification('Nova Analytics Hub loaded successfully', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showNotification('Dashboard initialization failed. Please refresh the page.', 'error');
            }
        });
    </script>
</body>
</html>